name: Update Packages

on:
    # Allow manual trigger
    workflow_dispatch:
    # Run on push to update packages before CI
    push:
        branches:
            - "*"

jobs:
    update-packages:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Update packages
              run: npm run update-packages

            - name: Check for changes
              id: check-changes
              run: |
                  if git diff --quiet package.json package-lock.json; then
                      echo "changes=false" >> $GITHUB_OUTPUT
                      echo "No package updates available"
                  else
                      echo "changes=true" >> $GITHUB_OUTPUT
                      echo "Package updates detected"
                  fi

            - name: Commit and push changes
              if: steps.check-changes.outputs.changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json package-lock.json
                  git commit -m "chore: update dependencies [skip ci]"
                  git push

            - name: Summary
              run: |
                  if [ "${{ steps.check-changes.outputs.changes }}" = "true" ]; then
                      echo "✅ Packages updated and committed" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "ℹ️ No package updates available" >> $GITHUB_STEP_SUMMARY
                  fi
